#!/usr/bin/env python3
import os
import sys
import time
import json
import requests
import subprocess
import base64
from urllib.parse import urlparse
import warnings
from urllib3.exceptions import InsecureRequestWarning

warnings.filterwarnings('ignore', category=InsecureRequestWarning)

class GitHubV2RayTester:
    def __init__(self):
        # 直接使用正确的路径
        self.v2ray_path = "./v2ray/v2ray"  # v2ray文件夹下的v2ray文件
        self.config_path = "./config.json"
        self.local_port = 10808
        self.v2ray_process = None
        
        self.test_urls = ["https://ip.sb"]
        self.speedtest_url = "https://speed.cloudflare.com/__down?bytes=1000000"
        
    def setup_v2ray(self):
        """检查V2Ray环境"""
        if not os.path.exists(self.v2ray_path):
            print(f"❌ V2Ray文件不存在: {self.v2ray_path}")
            return False
        
        # 设置执行权限
        os.chmod(self.v2ray_path, 0o755)
        print("✅ V2Ray准备就绪")
        return True
    
    def parse_node_config(self, config):
        """解析节点配置"""
        try:
            if config.startswith('vmess://'):
                return self.parse_vmess(config)
            elif config.startswith('vless://'):
                return self.parse_vless(config)
            elif config.startswith('trojan://'):
                return self.parse_trojan(config)
            elif config.startswith('ss://'):
                return self.parse_ss(config)
            else:
                print(f"❌ 不支持的协议")
                return None
        except Exception as e:
            print(f"❌ 解析配置失败: {e}")
            return None
    
    def parse_vmess(self, config):
        """解析VMess配置"""
        try:
            encoded = config[8:]
            padding = 4 - len(encoded) % 4
            if padding != 4:
                encoded += '=' * padding
            
            decoded = base64.b64decode(encoded).decode('utf-8')
            vmess = json.loads(decoded)
            
            return {
                "inbounds": [{
                    "port": self.local_port,
                    "listen": "127.0.0.1",
                    "protocol": "socks",
                    "settings": {"udp": True, "auth": "noauth"}
                }],
                "outbounds": [{
                    "protocol": "vmess",
                    "settings": {
                        "vnext": [{
                            "address": vmess["add"],
                            "port": int(vmess["port"]),
                            "users": [{
                                "id": vmess["id"],
                                "alterId": int(vmess.get("aid", 0))
                            }]
                        }]
                    },
                    "streamSettings": {
                        "network": vmess.get("net", "tcp")
                    }
                }]
            }
        except Exception as e:
            print(f"❌ 解析VMess失败: {e}")
            return None
    
    def parse_vless(self, config):
        """解析VLESS配置"""
        try:
            parsed = urlparse(config)
            params = dict(p.split('=') for p in parsed.query.split('&') if '=' in p)
            
            return {
                "inbounds": [{
                    "port": self.local_port,
                    "listen": "127.0.0.1",
                    "protocol": "socks",
                    "settings": {"udp": True, "auth": "noauth"}
                }],
                "outbounds": [{
                    "protocol": "vless",
                    "settings": {
                        "vnext": [{
                            "address": parsed.hostname,
                            "port": parsed.port or 443,
                            "users": [{"id": parsed.username, "encryption": "none"}]
                        }]
                    },
                    "streamSettings": {
                        "network": params.get('type', 'tcp')
                    }
                }]
            }
        except Exception as e:
            print(f"❌ 解析VLESS失败: {e}")
            return None
    
    def parse_trojan(self, config):
        """解析Trojan配置"""
        try:
            parsed = urlparse(config)
            
            return {
                "inbounds": [{
                    "port": self.local_port,
                    "listen": "127.0.0.1",
                    "protocol": "socks",
                    "settings": {"udp": True, "auth": "noauth"}
                }],
                "outbounds": [{
                    "protocol": "trojan",
                    "settings": {
                        "servers": [{
                            "address": parsed.hostname,
                            "port": parsed.port or 443,
                            "password": parsed.username
                        }]
                    },
                    "streamSettings": {
                        "security": "tls"
                    }
                }]
            }
        except Exception as e:
 