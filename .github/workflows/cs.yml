name: Proxy Speed Test

on:
  push:
    branches: [ main, master ]
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

jobs:
  speed-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y iputils-ping
        
    - name: Create sub.txt if not exists
      run: |
        if [ ! -f "sub.txt" ]; then
          echo "创建 sub.txt 文件..."
          cat > sub.txt << 'EOF'
        # 代理链接示例（请替换为真实链接）
        vmess://ewoidiI6ICIyIiwKInBzIjogInRlc3QiLAoiYWRkIjogImdvb2dsZS5jb20iLAoicG9ydCI6IDQ0MywKImFpZCI6IDAsCiJpZCI6ICIxMjM0NTY3ODkwLWFiY2QtZWZnZy1oaWprLTEyMzQ1Njc4OTAiLAoibmV0IjogInRjcCIsCiJ0eXBlIjogIm5vbmUiLAoiaG9zdCI6ICIiLAoicGF0aCI6ICIiLAoidGxzIjogIiIsCiJzbmkiOiAiIgp9
        ss://YWVzLTI1Ni1nY206cGFzc3dvcmRAMTQ0LjE2OC4xLjE6ODA4MA==
        trojan7://cGFzc3dvcmRAMTQ0LjE2OC4xLjE6NDQz
        EOF
        fi
        
        echo "当前目录文件:"
        ls -la
        echo "sub.txt 内容:"
        cat sub.txt
    
    - name: Run speed test
      run: |
        echo "开始代理延迟测试..."
        python cs.py
        
        echo "测试完成，查看结果文件:"
        ls -la res.txt
        echo "res.txt 内容:"
        cat res.txt || echo "res.txt 文件为空或不存在"
    
    - name: Save results to repository
      run: |
        # 设置git配置
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        
        # 添加结果文件
        git add res.txt
        
        # 提交更改
        git commit -m "自动更新代理测试结果 $(date +'%Y-%m-%d %H:%M:%S')" || echo "无变更"
        
        # 推送更改
        git push
    
    - name: Upload results as artifact
      uses: actions/upload-artifact@v4
      with:
        name: speed-test-results
        path: |
          res.txt
          sub.txt
        retention-days: 7
