name: Unified Node Pipeline

on:
  workflow_dispatch:
  schedule:
    - cron: "5 21 * * *"

permissions:
  contents: write

jobs:
  pipeline:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          if [ -f "requirements.txt" ]; then
            pip install -r requirements.txt
          else
            pip install httpx beautifulsoup4 pydantic aiohttp requests rich pysocks
          fi

      # --------- ç¬¬ä¸€é˜¶æ®µï¼šç”Ÿæˆ sub.txt ---------
      - name: Run collector scripts (@ folder)
        working-directory: '@'
        run: |
          echo "ğŸ“¦ æ”¶é›†å¹¶åˆå¹¶èŠ‚ç‚¹..."
          [ -f "app.py" ] && python app.py || echo "app.py ä¸å­˜åœ¨"
          [ -f "sort.py" ] && python sort.py || echo "sort.py ä¸å­˜åœ¨"
          [ -f "best.py" ] && python best.py || echo "best.py ä¸å­˜åœ¨"

      # --------- ç¬¬äºŒé˜¶æ®µï¼šå‡†å¤‡ Xray ---------
      - name: Restore xray cache
        id: cache-xray
        uses: actions/cache@v4
        with:
          path: xray
          key: xray-linux-amd64-v1

      - name: Download xray if missing
        if: steps.cache-xray.outputs.cache-hit != 'true'
        run: |
          echo "â¬‡ï¸ ä¸‹è½½ Xray..."
          mkdir -p xray
          curl -L https://github.com/XTLS/Xray-core/releases/download/v1.8.13/Xray-linux-64.zip -o xray.zip
          unzip xray.zip -d xray
          chmod +x xray/xray

      - name: Restore sing-box cache
        id: cache-singbox
        uses: actions/cache@v4
        with:
          path: sing-box
          key: sing-box-${{ steps.get_version.outputs.version }}-linux-amd64
          restore-keys: |
            sing-box-linux-amd64-

      - name: Download and setup sing-box
        if: steps.cache-singbox.outputs.cache-hit != 'true'
        run: |
          echo "â¬‡ï¸ ä¸‹è½½ Sing-box ${{ steps.get_version.outputs.version }}..."
          mkdir -p sing-box
          
          # ä¸‹è½½å¯¹åº”ç‰ˆæœ¬
          wget -q https://github.com/SagerNet/sing-box/releases/download/v1.8.0/sing-box-1.8.0-linux-amd64.tar.gz" -O sing-box.tar.gz
          
          # è§£å‹
          tar -xzf sing-box.tar.gz -C sing-box --strip-components=1
          
          # è®¾ç½®æ‰§è¡Œæƒé™
          chmod +x sing-box/sing-box
          
          # éªŒè¯å®‰è£…
          echo "ğŸ”§ Sing-box ç‰ˆæœ¬ä¿¡æ¯:"
          ./sing-box/sing-box version
          
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -f sing-box.tar.gz
          
          echo "âœ… Sing-box å®‰è£…å®Œæˆ"
      # --------- ç¬¬ä¸‰é˜¶æ®µï¼šæµ‹è¯•èŠ‚ç‚¹ ---------
      - name: Test nodes with Xray
        run: |
          chmod +x sing-box/sing-box
          python3 sb.py

      # --------- ç¬¬å››é˜¶æ®µï¼šç»Ÿä¸€æäº¤ ---------
      - name: Commit changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add -A

          if ! git diff --staged --quiet; then
            git commit -m "ğŸ¤– Auto update nodes ($(date -u '+%Y-%m-%d %H:%M:%S UTC'))"
            git push
          else
            echo "âœ… æ²¡æœ‰å˜æ›´"
          fi
