name: Unified Config Updater

on:
  workflow_dispatch:
  schedule:
    - cron: "5 21 * * *"

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'  # å¯ç”¨ç¼“å­˜åŠ å¿«é€Ÿåº¦

    - name: Install unified dependencies
      run: |
        echo "å®‰è£…ç»Ÿä¸€ä¾èµ–..."
        pip install --upgrade pip
        if [ -f "requirements.txt" ]; then
          pip install -r requirements.txt
        else
          # å¦‚æœæ²¡æœ‰requirements.txtï¼Œå®‰è£…é»˜è®¤ä¾èµ–
          pip install httpx beautifulsoup4 pydantic aiohttp requests rich
        fi
    - name: Run @ folder scripts
      working-directory: '@'
      run: |
        echo "è¿è¡Œ@æ–‡ä»¶å¤¹è„šæœ¬..."
        [ -f "app.py" ] && python app.py || echo "app.pyä¸å­˜åœ¨"
        [ -f "sort.py" ] && python sort.py || echo "sort.pyä¸å­˜åœ¨"
        [ -f "best1.py" ] && python best.py || echo "best.pyä¸å­˜åœ¨"
    - name: Download V2Ray
      run: |
        mkdir -p v2ray
        cd v2ray
        wget https://github.com/v2fly/v2ray-core/releases/download/v5.7.0/v2ray-linux-64.zip
        unzip v2ray-linux-64.zip
        chmod +x v2ray
    - name: Install Xray
      run: |
        sudo bash -c "$(curl -L https://github.com/XTLS/Xray-install/raw/main/install-release.sh)" @ install
        xray version

    - name: Run test script
      run: |
        echo "è¿è¡Œæµ‹è¯•è„šæœ¬..."
        [ -f "test.py" ] && python v2.py || echo "test.pyä¸å­˜åœ¨"

    - name: Commit changes
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        git add -A
        if ! git diff --staged --quiet; then
          git commit -m "ğŸ¤– Update: $(TZ='Asia/Tehran' date '+%Y-%m-%d %H:%M:%S %Z')"
          git push
        else
          echo "âœ… æ²¡æœ‰å˜æ›´"
        fi
