name: Unified Node Pipeline

on:
  workflow_dispatch:
  schedule:
    - cron: "5 21 * * *"

permissions:
  contents: write

jobs:
  pipeline:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          if [ -f "requirements.txt" ]; then
            pip install -r requirements.txt
          else
            pip install httpx beautifulsoup4 pydantic aiohttp requests rich pysocks
          fi

      # --------- ç¬¬ä¸€é˜¶æ®µï¼šç”Ÿæˆ sub.txt ---------
      - name: Run collector scripts (@ folder)
        working-directory: '@'
        run: |
          echo "ğŸ“¦ æ”¶é›†å¹¶åˆå¹¶èŠ‚ç‚¹..."
          [ -f "app.py" ] && python app.py || echo "app.py ä¸å­˜åœ¨"
          [ -f "sort.py" ] && python sort.py || echo "sort.py ä¸å­˜åœ¨"
          [ -f "best.py" ] && python best.py || echo "best.py ä¸å­˜åœ¨"

      # --------- ç¬¬äºŒé˜¶æ®µï¼šå‡†å¤‡ Xray ---------
      - name: Restore xray cache
        id: cache-xray
        uses: actions/cache@v4
        with:
          path: xray
          key: xray-linux-amd64-v1

      - name: Download xray if missing
        if: steps.cache-xray.outputs.cache-hit != 'true'
        run: |
          echo "â¬‡ï¸ ä¸‹è½½ Xray..."
          mkdir -p xray
          curl -L https://github.com/XTLS/Xray-core/releases/download/v1.8.13/Xray-linux-64.zip -o xray.zip
          unzip xray.zip -d xray
          chmod +x xray/xray

      # --------- ç¬¬ä¸‰é˜¶æ®µï¼šæµ‹è¯•èŠ‚ç‚¹ ---------
      - name: Test nodes with Xray
        run: |
          chmod +x xray/xray
          python3 test_xray_nodes.py

      # --------- ç¬¬å››é˜¶æ®µï¼šç»Ÿä¸€æäº¤ ---------
      - name: Commit changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add -A

          if ! git diff --staged --quiet; then
            git commit -m "ğŸ¤– Auto update nodes ($(date -u '+%Y-%m-%d %H:%M:%S UTC'))"
            git push
          else
            echo "âœ… æ²¡æœ‰å˜æ›´"
          fi
